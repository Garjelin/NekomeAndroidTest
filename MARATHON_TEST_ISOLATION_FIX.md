# üîß Marathon Test Isolation Fix

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–µ—Å—Ç–æ–≤ —á–µ—Ä–µ–∑ Marathon:
- ‚úÖ **–ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç** –ø—Ä–æ—Ö–æ–¥–∏—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
- ‚ùå **–í—Ç–æ—Ä–æ–π —Ç–µ—Å—Ç** –ø–∞–¥–∞–µ—Ç, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–º–µ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∞ –ª–æ–≥–∏–Ω–∞

### –ü—Ä–∏—á–∏–Ω–∞
–ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Å—Ç–∞–µ—Ç—Å—è –∑–∞–ª–æ–≥–∏–Ω–µ–Ω–Ω—ã–º, –∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤—Ç–æ—Ä–æ–≥–æ —Ç–µ—Å—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–º–µ—Å—Ç–æ —ç–∫—Ä–∞–Ω–∞ –ª–æ–≥–∏–Ω–∞.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### –û–±–Ω–æ–≤–ª–µ–Ω BaseComposeTest
–î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –∏ –ª–æ–≥–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –º–µ–∂–¥—É —Ç–µ—Å—Ç–∞–º–∏:

#### 1. –ü—Ä–∞–≤–∏–ª–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:
```kotlin
@get:Rule(order = 1)
val clearDatabase = ClearDatabaseRule()

@get:Rule(order = 2) 
val clearPreferences = ClearPreferencesRule()
```

#### 2. –ò–Ω—ä–µ–∫—Ü–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```kotlin
@Inject
lateinit var authProvider: AuthProvider

@Inject
lateinit var applicationPreferences: ApplicationPreferences

@Inject
lateinit var seriesPreferences: SeriesPreferences
```

#### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤ setUp():
```kotlin
@Before
open fun setUp() {
    hiltRule.inject()
    
    // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    runBlocking {
        applicationPreferences.reset()
        seriesPreferences.reset()
    }
    
    // –õ–æ–≥–∞—É—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Ç–µ—Å—Ç –Ω–∞—á–∏–Ω–∞–ª—Å—è —Å —ç–∫—Ä–∞–Ω–∞ –ª–æ–≥–∏–Ω–∞
    authProvider.logout()
}
```

#### 4. –ú–µ—Ç–æ–¥ –¥–ª—è —è–≤–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏:
```kotlin
protected fun clearAppState() {
    runBlocking {
        applicationPreferences.reset()
        seriesPreferences.reset()
    }
    authProvider.logout()
}
```

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- 1-–π —Ç–µ—Å—Ç: ‚úÖ –õ–æ–≥–∏–Ω ‚Üí –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
- 2-–π —Ç–µ—Å—Ç: ‚ùå –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- 1-–π —Ç–µ—Å—Ç: ‚úÖ –õ–æ–≥–∏–Ω ‚Üí –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí –õ–æ–≥–∞—É—Ç
- 2-–π —Ç–µ—Å—Ç: ‚úÖ –õ–æ–≥–∏–Ω ‚Üí –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Üí –õ–æ–≥–∞—É—Ç

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
–ù–∏—á–µ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–ª–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ - –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —Ç–µ—Å—Ç–æ–º.

### –†—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
```kotlin
@Test
fun myTest() = run {
    // –í–∞—à —Ç–µ—Å—Ç
    
    // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–µ—Ä–µ–¥–∏–Ω–µ —Ç–µ—Å—Ç–∞
    clearAppState()
    
    // –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
}
```

## üìù –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –†–µ—à–µ–Ω–∏–µ 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å @After –¥–ª—è –ª–æ–≥–∞—É—Ç–∞
```kotlin
@After
fun tearDown() {
    authProvider.logout()
}
```

### –†–µ—à–µ–Ω–∏–µ 2: –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∞—É—Ç –≤ –∫–æ–Ω–µ—Ü –∫–∞–∂–¥–æ–≥–æ —Ç–µ—Å—Ç–∞
```kotlin
@Test
fun myTest() = run {
    scenario(Login(TEST_USER_1, composeTestRule))
    // –¢–µ—Å—Ç
    
    step("–õ–æ–≥–∞—É—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è") {
        authProvider.logout()
    }
}
```

### –†–µ—à–µ–Ω–∏–µ 3: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Marathon –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚ö†Ô∏è **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –û–ø—Ü–∏—è `clearPackageData` –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –≤ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Marathon (>0.6.5).
–í Marathon 0.6.5 —ç—Ç–∞ –æ–ø—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏–∑–æ–ª—è—Ü–∏—é —á–µ—Ä–µ–∑ BaseComposeTest.

## ‚úÖ –°—Ç–∞—Ç—É—Å
- ‚úÖ BaseComposeTest –æ–±–Ω–æ–≤–ª–µ–Ω —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—á–∏—Å—Ç–∫–æ–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –º–µ—Ç–æ–¥ –¥–ª—è —Ä—É—á–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úÖ –¢–µ—Å—Ç—ã —Ç–µ–ø–µ—Ä—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã –¥—Ä—É–≥ –æ—Ç –¥—Ä—É–≥–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
–ó–∞–ø—É—Å—Ç–∏—Ç–µ Marathon –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```bash
./run_marathon.sh
```

–û–±–∞ —Ç–µ—Å—Ç–∞ –≤ `CollectionScreenTest` –¥–æ–ª–∂–Ω—ã –ø—Ä–æ—Ö–æ–¥–∏—Ç—å —É—Å–ø–µ—à–Ω–æ!
